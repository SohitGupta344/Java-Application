trigger:
- main

pool:
  name: Default   # Self-hosted agent (Tomcat + SonarQube yahin installed)

variables:
  MAVEN_OPTS: "-Xmx1024m"
  TOMCAT_HOME: "C:\\Tools\\tomcat\\apache-tomcat-9.0.113"
  WAR_NAME: "JavaLoginShowcase-1.0.0.war"

stages:

# ==================================
# STAGE 1: SONARQUBE ANALYSIS
# ==================================
- stage: StaticCodeAnalysis
  displayName: Static Code Analysis
  jobs: 
  - job: SonarQubeAnalysis
    displayName: Static Code Analysis (SonarQube)
    steps:
    - task: PowerShell@2
      displayName: Static Code Analysis
      inputs:
        targetType: 'inline'
        script: 'sonar-scanner --define sonar.projectKey=java-application --define sonar.projectName=java-application --define sonar.sources=src --define sonar.exclusions=node_modules/**,build/** --define sonar.host.url=http://localhost:9000 --define sonar.token=sqp_1ec77f76707017438dea02caf728439b66f849bd'

# ==================================
# STAGE 2: BUILD (MAVEN WAR)
# ==================================
- stage: Build
  displayName: Build WAR
  dependsOn: StaticCodeAnalysis
  condition: succeeded()
  jobs:
  - job: BuildJob
    displayName: Maven Build
    steps:
    - task: Maven@4
      displayName: Maven Clean Package
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.17'
        publishJUnitResults: true

    - task: PublishPipelineArtifact@1
      displayName: Publish WAR Artifact
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/target'
        artifact: 'war-drop'

# ==================================
# STAGE 3: DEPLOY TO TOMCAT
# ==================================
- stage: Deploy
  displayName: Deploy to Tomcat
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployJob
    displayName: Tomcat Deployment
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: Download WAR
      inputs:
        artifact: 'war-drop'
        path: '$(System.DefaultWorkingDirectory)/deploy'

    - powershell: |
        Write-Host "Stopping Tomcat"
        & "$(TOMCAT_HOME)\bin\shutdown.bat"
        Start-Sleep -Seconds 10

        Write-Host "Deploying WAR"
        Copy-Item "$(System.DefaultWorkingDirectory)\deploy\$(WAR_NAME)" `
                  "$(TOMCAT_HOME)\webapps\JavaLoginShowcase.war" -Force

        Write-Host "Starting Tomcat"
        & "$(TOMCAT_HOME)\bin\startup.bat"
      displayName: Deploy WAR to Tomcat
